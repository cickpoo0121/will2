<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.3/css/responsive.bootstrap4.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.3/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.3/js/responsive.bootstrap4.min.js"></script>
    <script src="https://use.fontawesome.com/releases/v5.0.8/js/all.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.12.0/moment.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"
        rel="stylesheet">
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-sweetalert/1.0.1/sweetalert.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-sweetalert/1.0.1/sweetalert.css">


    <!-- datepicker -->
    <!-- <script
        src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/jquery-datetimepicker/2.5.20/jquery.datetimepicker.full.min.js"></script>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.4.1/css/bootstrap-datepicker3.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/js/bootstrap-datepicker.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"> -->


    <title>การตรวจสอบและนับครุภัณฑ์</title>
</head>
<style>
    #log {
        width: 100px;
    }

    .date {
        color: #fc0000;
        ;
    }

    .highlightRow {
        color: red;
    }

    .nav-user {}

    .nav-user-dropdown {
        padding: 0px;
        min-width: 230px;
        margin: 0px;
    }

    .nav-user-name {}

    .nav-user-info {
        background-color: #CC1D10;
        line-height: 1.2;
        padding: 12px;
        color: #fff;
        font-size: 13px;
        border-radius: 2px 2px 0 0;
    }

    .nav-user-info .status {
        float: left;
        top: 7px;
        left: 0px;
    }

    .nav-user-dropdown {}

    .nav-user-dropdown .dropdown-item {
        display: block;
        width: 100%;
        padding: 12px 22px 15px;
        clear: both;
        font-weight: 400;
        color: #686972;
        text-align: inherit;
        white-space: nowrap;
        background-color: transparent;
        border: 0;
        font-size: 13px;
        line-height: 0.4;
    }

    .nav-user-dropdown .dropdown-item:hover {
        /* background-color: #f7f7fb; */
        color: red;
    }

    .nav-user .dropdown-toggle::after {
        display: inline-block;
        width: 0;
        height: 0;
        margin-left: .255em;
        vertical-align: .255em;
        content: "";
        border: none;
    }

    .nav-user-dropdown {
        padding: 0px;
        margin: 0px;
        margin-top: 74px;

    }
</style>

<body>
    <!-- Header -->
    <div class="row">
        <div class="col-md-9">
            <img src="../img/banner.png" alt="LOGO" style="width: 450px;">
        </div>
        <div class="col-md-3">

            <!-- <li class="nav-item dropdown nav-user"> -->
            <a class="nav-link nav-user-img" href="#" id="navbarDropdownMenuLink2" data-toggle="dropdown"
                aria-haspopup="true" aria-expanded="false"><img src="" id="imguser" alt=""
                    class="user-avatar-md rounded-circle mt-3 float-right " style="width: 50px;height: 50px;"></a>
            <div class="dropdown-menu dropdown-menu-right nav-user-dropdown" aria-labelledby="navbarDropdownMenuLink2">
                <div class="nav-user-info">
                    <h6 class="mb-0 text-white nav-user-name" id="NameUser">John Abraham </h6>

                </div>
                <a class="dropdown-item" href="/auth/logout">
                    <h6><i class="fas fa-power-off mr-2"></i>Logout</h6>
                </a>
            </div>
            <!-- </li> -->

        </div>
    </div>
    <!-- Header -->

    <!-- Menu -->
    <div>

        <nav class="navbar navbar-expand-lg navbar-light  " style="background-color: #fe0000;">
            <a class="navbar-brand ml-5" href="#"></a>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item active ml-5">
                        <a href="/adminfirstpage" class="nav-link text-light ">หน้าแรก</a>
                    </li>
                    <li class="nav-item ml-5">
                        <a class="nav-link text-light" href="/productstatusadmin">สถานะครุภัณฑ์</a>
                    </li>
                    <li class="nav-item ml-5">
                        <a class="nav-link text-light " href="/assignCommittee">คณะกรรมการประจำปี</a>
                    </li>
                    <li class="nav-item ml-5">
                        <a class="btn btn-rounded btn-light  " href="/assignCheckingDate">เวลาการตรวจสอบครุภัณฑ์</a>
                    </li>



                </ul>
            </div>
        </nav>
    </div>

    <!-- Menu -->

    <!-- Date Check -->

    <!-- <div class="mt-3"> -->
    <div class="row">
        <div class="col-1">

        </div>
        <div class="col-4">
            <!-- <h2 class="text-right ml-3 ">ระยะเวลาการตรวจสอบครุภัณฑ์</h2> -->
        </div>
        <div class="col-4">

        </div>
        <div class="col-2 ">
            <!-- Button trigger modal -->
            <!-- <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModalLong">
                    เพิ่ม
                </button> -->

            <!-- Modal -->
            <div class="modal fade" id="exampleModalLong" tabindex="-1" role="dialog"
                aria-labelledby="exampleModalLongTitle" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLongTitle">กำหนดเวลา</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <!-- <div class="card-body border-top"> -->
                            <div class="form-group">
                                <div class="input-group date" id="datetimepicker1" data-target-input="nearest">
                                    <input type="text" id="dateStart" class="form-control datetimepicker-input"
                                        data-target="#datetimepicker1" placeholder="วันเริ่มต้น" />
                                    <div class="input-group-append" data-target="#datetimepicker1"
                                        data-toggle="datetimepicker">
                                        <div class="input-group-text"><i class="far fa-calendar-alt"></i></div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="input-group date" id="datetimepicker2" data-target-input="nearest">
                                    <input type="text" id="dateEnd" class="form-control" placeholder="วันสิ้นสุด" />
                                    <div class="input-group-append" data-target="#datetimepicker2"
                                        data-toggle="datetimepicker">
                                        <div class="input-group-text"><i class="far fa-calendar-alt"></i></div>
                                    </div>
                                </div>
                            </div>
                            <!-- </div> -->
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">ยกเลิก</button>
                            <button id="adddate" type="button" class="btn btn-primary">บันทึก</button>
                            <button id="editdate" type="button" class="btn btn-primary">บันทึก</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-12 mt-3">
            <div class="card">
                <div class="card-header">
                    <div class="row">
                        <div class="col-md-4">
                            <h2>ระยะเวลาการตรวจสอบครุภัณฑ์ </h2>
                        </div>
                        <div class="col-md-2">
                        </div>
                        <div class="col-md-6 mt-2" style="text-align: right;">
                            <button type="button" class="btn btn-danger float-right ml-2" id="btnedit"
                                data-toggle="modal" data-target="#exampleModalLong" style="background-color: #dc3545;">
                                แก้ไขวันที่
                            </button>
                            <button type="button" class="btn btn-danger float-right" id="btnadd" data-toggle="modal"
                                data-target="#exampleModalLong" style="background-color: #dc3545;">
                                กำหนดวันที่
                            </button>

                        </div>
                    </div>
                </div>

                <div class="container-fluid text-center mt-3">
                    <table class="table  mt-2" id="mytable" style="width:100%">
                        <thead>
                            <tr>
                                <!-- <th>year_alert</th> -->
                                <th>ปี</th>
                                <th>วันเริ่มต้น</th>
                                <th>วันสิ้นสุด</th>
                                <!-- <th>แก้ไขวันที่</th> -->
                            </tr>
                        </thead>
                    </table>
                </div>


            </div>
        </div>
    </div>

    <br><br><br><br><br>

    <!-- Footer -->
    <footer class="page-footer font-small blue " style="background-color: #fe0000;">

        <!-- Copyright -->
        <div class="footer-copyright text-center py-3 text-light">© 2020 POWERSOL</div>
        <!-- Copyright -->

    </footer>
    <!-- Footer -->

</body>
<script>
    $(document).ready(function () {

        //check login
        $.ajax({
            method: "GET",
            url: "/profile/userinfor"
        }).done(function (dataSet, state, xhr) {
            var email = dataSet.email;
            console.log(dataSet.name);
            console.log(dataSet.email);
            if (dataSet.name == undefined) {
                window.location.replace('/');
            } else {
                $.ajax({
                    type: "GET",
                    url: "/CheckRole/" + email
                }).done(function (data, state, xhr) {
                    console.log(data[0].role);
                    if (data[0].role == 1) {
                        $('#NameUser').html(dataSet.name)
                        $('#imguser').attr("src", "" + dataSet.photo + "");
                    } else if (data[0].role == 0) {
                        window.location.replace("/periodOfCheckingAsset");
                    } else if (email == undefined) {
                        window.location.replace('/');
                    }
                }).fail(function (xhr, state, err) {
                    console.log(err);
                })
            }
            // window.location.replace('/committeefirstpage')

        }).fail(function (xhr, state, err) {
            // console.log(err)
        })

        $('#datetimepicker2').datepicker({
            format: 'yyyy-mm-dd',
            todayHighlight: true,
            autoclose: true
        })

        $('#datetimepicker1').datepicker({
            format: 'yyyy-mm-dd',
            todayHighlight: true,
            autoclose: true
        })

        tableUser = $("#mytable").DataTable({
            // data: dataSet,
            // "searching": false,
            // "paging": false,
            "ordering": false,
            "info": false,
            "lengthChange": false,
            deferRender: true,
            responsive: true,
            columns: [
                // { data: "year_alert", visible: false },
                { data: "year_alert" },
                { data: "date_start" },
                { data: "date_end" },
                // {
                //     data: "year_alert",
                //     render: function (data, type, full, meta) {
                //         return data ? '<button class="btn btn-primary edit1"  id="edit' + full.year_alert + '">แก้ไข</button>' : '';
                //     }
                // }
            ],

        });
        productadmin()


        // $("#editdate").click(function () {
        //     let dateStart = $("#dateStart").val();
        //     let dateEnd = $("#dateEnd").val();

        //     var date1 = new Date(dateStart);
        //     var date2 = new Date(dateEnd);

        //     let caldate = date2.getTime() - date1.getTime();
        //     let time2date = caldate / (1000 * 3600 * 24)
        //     // alert(time2date)

        //     if (time2date <= 0) {
        //         alert("Please check you select Date")
        //     }
        //     else {
        //         $.ajax({
        //             method: "POST",
        //             url: "/datealert/insert",
        //             data: { datestart: dateStart, dateend: dateEnd }
        //         }).done(function (dataSet, state, xhr) {
        //             productadmin();
        //             $("#exampleModalLong").modal("toggle");
        //         }).fail(function (xhr, state, error) {

        //         })
        //     }


        // });


    });

    function productadmin() {

        $.ajax({
            method: "GET",
            url: "/datealert"
        }).done(function (dataSet, state, xhr) {
            console.log(dataSet)
            //clear DataTable
            tableUser.clear();
            //display modified JSON in DataTable
            tableUser.rows.add(dataSet).draw();

            if (dataSet.length == 0) {
                $("#btnedit").hide();
            }
            else {
                $("#btnedit").show();
            }

            for (let i = 0; i < dataSet.length; i++) {
                if (dataSet[i].year_alert == new Date().getFullYear()) {
                    // $("#btnadd").prop('disabled', true);
                    $("#btnadd").hide();
                    // console.log(dataSet[i].year_alert)
                }
                // console.log(date=new Date().getFullYear)
            }

            var tr = document.getElementById("mytable").getElementsByTagName("TR");
            tr[1].className = "highlightRow"
            // selectedData = tableUser.row(1).data();
            // console.log(selectedData)

            $("#btnadd").click(function () {
                $("#editdate").hide();
                $("#adddate").show();

                $("#adddate").click(function () {

                    let dateStart = $("#dateStart").val();
                    let dateEnd = $("#dateEnd").val();

                    var date1 = new Date(dateStart);
                    var date2 = new Date(dateEnd);

                    let caldate = date2.getTime() - date1.getTime();
                    let time2date = caldate / (1000 * 3600 * 24)

                    // console.log(date1.getFullYear())

                    if (time2date <= 0) {
                        // alert("กรุณาเลือกวันที่ให้ถูกต้อง")
                        swal({
                            title: "กรุณาเลือกวันที่ให้ถูกต้อง",
                            type: "info",
                            confirmButtonClass: "btn-primary",
                            confirmButtonText: "ตกลง",
                            closeOnConfirm: true,
                        })
                    } else if (dateStart == "" || dateEnd == "") {
                        // alert("กรุณาเลือกวันที่")
                        swal({
                            title: "กรุณาเลือกวันที่",
                            type: "info",
                            confirmButtonClass: "btn-primary",
                            confirmButtonText: "ตกลง",
                            closeOnConfirm: true,
                        })
                    }
                    else {
                        $.ajax({
                            method: "POST",
                            url: "/datealert/insert",
                            data: { datestart: dateStart, dateend: dateEnd }
                        }).done(function (dataSet, state, xhr) {
                            productadmin();
                            $("#exampleModalLong").modal("toggle");
                            // $("#editdate").show();
                        }).fail(function (xhr, state, error) {

                        })
                    }
                });
            })


            $("#btnedit").click(function () {
                $("#adddate").hide();
                $("#editdate").show();
                selectedData = tableUser.row(0).data();
                console.log(selectedData.year_alert)
                $("#dateStart").val(selectedData.date_start);
                $("#dateEnd").val(selectedData.date_end);

                $.ajax({
                    method: "GET",
                    url: "product/checkscan/" + selectedData.year_alert
                }).done(function (dataSet, state, xhr) {
                    console.log(dataSet[0])
                    for (let i = 0; i < dataSet.length; i++) {
                        if (dataSet[i].product_status != 0) {
                            $("#dateStart").prop('disabled', true);
                        }
                    }
                }).fail(function (xhr, sate, err) {

                })
            })
        }).fail(function (xhr, state, error) {
            //get data failed
            alert(xhr.responseText);
        });

        $("#editdate").click(function () {

            let dateStart = $("#dateStart").val();
            let dateEnd = $("#dateEnd").val();
            let year = selectedData.year_alert

            var date1 = new Date(dateStart);
            var date2 = new Date(dateEnd);

            let caldate = date2.getTime() - date1.getTime();
            let time2date = caldate / (1000 * 3600 * 24)
            // alert(time2date)
            // console.log(date2.getFullYear())

            if (date1.getFullYear() != new Date().getFullYear() || date2.getFullYear() != new Date().getFullYear()) {
                swal({
                    title: "กรุณาเลือกวันที่ภายในปีนี้",
                    type: "info",
                    confirmButtonClass: "btn-primary",
                    confirmButtonText: "ตกลง",
                    closeOnConfirm: true,
                })

            }
            else if (dateStart == "" || dateEnd == "") {
                // alert("กรุณาเลือกวันที่")
                swal({
                    title: "กรุณาเลือกวันที่",
                    type: "info",
                    confirmButtonClass: "btn-primary",
                    confirmButtonText: "ตกลง",
                    closeOnConfirm: true,
                })
            }
            else if (time2date <= 0) {
                // alert("กรุณาเลือกวันที่ในปีนี้")
                // $("#dateEnd").val("");
                // alert("กรุณาเลือกวันที่ให้ถูกต้อง")
                swal({
                    title: "กรุณาเลือกวันที่ให้ถูกต้อง",
                    type: "info",
                    confirmButtonClass: "btn-primary",
                    confirmButtonText: "ตกลง",
                    closeOnConfirm: true,
                })
            }
            else {
                $.ajax({
                    method: "PUT",
                    url: "/datealert/update/" + year,
                    data: { datestart: dateStart, dateend: dateEnd }
                }).done(function (dataSet, state, xhr) {
                    swal("เสร็จสิ้น", "ลบข้อมูลครุภันฑ์เสร็จสิ้น", "success");
                    productadmin();
                    $("#exampleModalLong").modal("toggle");
                }).fail(function (xhr, state, error) {

                })
            }
        });
    }

</script>

</html>